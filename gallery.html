<script>
function initMasonry() {
  const grid = document.querySelector('.gallery-grid');
  if (!grid) return;

  const gap = 16;
  let columnCount;

  if (window.innerWidth < 700)        columnCount = 1;
  else if (window.innerWidth < 1000)  columnCount = 2;
  else                                columnCount = 3;   // ← feel free to use 3–4 on wide screens

  const columns = new Array(columnCount).fill(0);
  const imgs = [...grid.querySelectorAll('img')];

  // Force images to be position:absolute early (CSS can do this too)
  imgs.forEach(img => {
    img.style.position = 'absolute';
    img.style.width = '100%';           // let natural aspect ratio work
    img.style.height = 'auto';
  });

  grid.style.position = 'relative';

  // Wait until ALL images are actually loaded before layout
  let loadedCount = 0;
  const total = imgs.length;

  function layoutWhenReady() {
    loadedCount++;
    if (loadedCount === total) {
      doLayout();
    }
  }

  function doLayout() {
    const gridWidth = grid.clientWidth;
    const colWidth = (gridWidth - gap * (columnCount - 1)) / columnCount;

    imgs.forEach(img => {
      // We no longer force fixed px width → CSS width:100% takes over
      const minCol = columns.indexOf(Math.min(...columns));

      img.style.left = `${(colWidth + gap) * minCol}px`;
      img.style.top  = `${columns[minCol]}px`;

      // Now img.height is real because image is loaded
      columns[minCol] += img.naturalHeight + gap;
    });

    grid.style.height = `${Math.max(...columns)}px`;
  }

  // Attach load listeners
  imgs.forEach(img => {
    if (img.complete && img.naturalHeight !== 0) {
      layoutWhenReady();
    } else {
      img.addEventListener('load', layoutWhenReady, { once: true });
      img.addEventListener('error', layoutWhenReady, { once: true }); // don't hang on broken images
    }
  });

  // If no images or all already cached → layout immediately
  if (loadedCount === total) {
    doLayout();
  }
}

// Run on load + resize
window.addEventListener('load', initMasonry);
window.addEventListener('resize', initMasonry);
</script>
